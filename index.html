<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Таймер до кино</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background-color: var(--bg-color);
    color: var(--text-color);
    transition: background-color 0.3s, color 0.3s;
    margin: 20px;
  }
  :root {
    --bg-color: #fff;
    --text-color: #222;
    --input-bg: #f0f0f0;
    --btn-bg: #007bff;
    --btn-color: #fff;
  }
  .dark-theme {
    --bg-color: #121212;
    --text-color: #eee;
    --input-bg: #333;
    --btn-bg: #0d6efd;
    --btn-color: #fff;
  }
  input[type="time"] {
    padding: 10px;
    font-size: 1.2em;
    background-color: var(--input-bg);
    border: 1px solid #ccc;
    border-radius: 5px;
    color: var(--text-color);
  }
  button {
    padding: 10px 15px;
    font-size: 1em;
    background-color: var(--btn-bg);
    border: none;
    border-radius: 5px;
    color: var(--btn-color);
    cursor: pointer;
    margin-left: 10px;
  }
  button:hover {
    background-color: #0056b3;
  }
  #timers {
    margin-top: 20px;
    font-size: 1.5em;
  }
  #shareMessage {
    margin-top: 10px;
    color: green;
    font-weight: bold;
  }
  .theme-toggle {
    margin-top: 20px;
  }
</style>
</head>
<body>
<h1>Таймер до кино</h1>

<label for="movieTime">Введите время начала кино:</label>
<input type="time" id="movieTime" step="60" />

<button id="startBtn">Запустить таймер</button>

<div class="theme-toggle">
  <label>
    <input type="checkbox" id="themeToggle" />
    Ночная тема
  </label>
</div>

<div id="timers" style="display:none;">
  <p>До выхода из дома осталось: <span id="leaveTimer">--:--:--</span></p>
  <p>До начала кино осталось: <span id="movieTimer">--:--:--</span></p>
</div>

<button id="shareBtn" style="display:none;">Поделиться таймером</button>
<div id="shareMessage"></div>

<audio id="alertSound" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" preload="auto"></audio>

<script>
  const movieTimeInput = document.getElementById('movieTime');
  const startBtn = document.getElementById('startBtn');
  const leaveTimerDisplay = document.getElementById('leaveTimer');
  const movieTimerDisplay = document.getElementById('movieTimer');
  const timersDiv = document.getElementById('timers');
  const shareBtn = document.getElementById('shareBtn');
  const shareMessage = document.getElementById('shareMessage');
  const alertSound = document.getElementById('alertSound');
  const themeToggle = document.getElementById('themeToggle');

  let intervalId = null;
  let leaveAlerted = false;
  let movieAlerted = false;

  // Ночная тема из localStorage
  if(localStorage.getItem('darkTheme') === 'true') {
    document.body.classList.add('dark-theme');
    themeToggle.checked = true;
  }

  themeToggle.addEventListener('change', () => {
    if(themeToggle.checked) {
      document.body.classList.add('dark-theme');
      localStorage.setItem('darkTheme', 'true');
    } else {
      document.body.classList.remove('dark-theme');
      localStorage.setItem('darkTheme', 'false');
    }
  });

  function playAlert() {
    alertSound.currentTime = 0;
    alertSound.play();
  }

  function parseTimeString(timeStr) {
    // timeStr: "HH:MM"
    const [h, m] = timeStr.split(':').map(Number);
    const now = new Date();
    const target = new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, m, 0);
    // Если время уже прошло сегодня — перенести на завтра
    if (target <= now) {
      target.setDate(target.getDate() + 1);
    }
    return target;
  }

  function formatTimeDiff(diffMs) {
    if(diffMs < 0) return "00:00:00";
    const totalSec = Math.floor(diffMs / 1000);
    const h = String(Math.floor(totalSec / 3600)).padStart(2, '0');
    const m = String(Math.floor((totalSec % 3600) / 60)).padStart(2, '0');
    const s = String(totalSec % 60).padStart(2, '0');
    return `${h}:${m}:${s}`;
  }

  function updateTimers(movieStart) {
    const now = new Date();
    const leaveTime = new Date(movieStart.getTime() - 60 * 60 * 1000); // минус 1 час
    const diffLeave = leaveTime - now;
    const diffMovie = movieStart - now;

    leaveTimerDisplay.textContent = formatTimeDiff(diffLeave);
    movieTimerDisplay.textContent = formatTimeDiff(diffMovie);

    if(diffLeave <= 0 && !leaveAlerted && diffMovie > 0) {
      playAlert();
      alert("Пора выходить из дома!");
      leaveAlerted = true;
    }

    if(diffMovie <= 0 && !movieAlerted) {
      playAlert();
      alert("Фильм начался!");
      movieAlerted = true;
      // Можно остановить таймер, если надо:
      // clearInterval(intervalId);
    }
  }

  function startTimer() {
    const timeVal = movieTimeInput.value;
    if(!timeVal) {
      alert("Введите время начала кино!");
      return;
    }
    const movieStart = parseTimeString(timeVal);

    leaveAlerted = false;
    movieAlerted = false;
    timersDiv.style.display = 'block';
    shareBtn.style.display = 'inline-block';
    updateTimers(movieStart);
    if(intervalId) clearInterval(intervalId);
    intervalId = setInterval(() => updateTimers(movieStart), 1000);

    // Обновляем ссылку на shareBtn с параметрами
    const url = new URL(window.location.href);
    url.searchParams.set('movie', timeVal);
    shareBtn.dataset.url = url.toString();
    shareMessage.textContent = "";
  }

  startBtn.addEventListener('click', startTimer);

  shareBtn.addEventListener('click', () => {
    if(!shareBtn.dataset.url) return;
    navigator.clipboard.writeText(shareBtn.dataset.url).then(() => {
      shareMessage.textContent = "Ссылка скопирована в буфер обмена!";
      setTimeout(() => { shareMessage.textContent = ""; }, 3000);
    }).catch(() => {
      shareMessage.textContent = "Не удалось скопировать ссылку.";
    });
  });

  // Если в URL есть параметр movie, сразу заполняем и запускаем таймер
  const params = new URLSearchParams(window.location.search);
  if(params.has('movie')) {
    movieTimeInput.value = params.get('movie');
    startTimer();
  }
</script>
</body>
</html>
