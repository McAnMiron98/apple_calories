<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Таймер до кино</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    max-width: 400px;
    margin: 30px auto;
    padding: 15px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    transition: background-color 0.3s, color 0.3s;
  }
  body.dark {
    background: #121212;
    color: #ddd;
  }
  h1 {
    margin-bottom: 25px;
    text-align: center;
  }
  label {
    display: block;
    margin-top: 15px;
    font-weight: 600;
  }
  input, button {
    width: 100%;
    padding: 10px;
    margin-top: 6px;
    font-size: 1rem;
    border-radius: 8px;
    border: none;
  }
  input[type="datetime-local"], input[type="number"] {
    box-sizing: border-box;
  }
  button {
    background-color: #ff6f61;
    color: white;
    cursor: pointer;
    font-weight: 700;
    transition: background-color 0.3s ease;
  }
  button:hover {
    background-color: #e85c50;
  }
  .timer {
    margin-top: 30px;
    background: rgba(255,255,255,0.15);
    padding: 25px 20px;
    border-radius: 14px;
  }
  body.dark .timer {
    background: rgba(255,255,255,0.05);
  }
  .timer div {
    font-size: 1.3rem;
    margin: 15px 0;
    font-weight: 600;
  }
  .time-value {
    font-family: 'Courier New', Courier, monospace;
    font-size: 1.6rem;
    color: #ffd700;
  }
  .progress-container {
    background: rgba(255,255,255,0.3);
    border-radius: 8px;
    overflow: hidden;
    height: 15px;
    margin-top: 8px;
  }
  body.dark .progress-container {
    background: rgba(255,255,255,0.1);
  }
  .progress-bar {
    height: 100%;
    background-color: #ffd700;
    width: 0%;
    transition: width 0.5s ease;
  }
  #resetBtn {
    background-color: #444;
    margin-top: 15px;
  }
  #themeToggle {
    margin-top: 10px;
    background-color: #444;
  }
  #shareBtn {
    background-color: #4caf50;
    margin-top: 10px;
  }
  @media (max-width: 450px) {
    body {
      margin: 15px;
      padding: 10px;
    }
  }
</style>
</head>
<body>

<h1>Таймер до кино</h1>

<label for="movieDateTime">Дата и время начала кино:</label>
<input type="datetime-local" id="movieDateTime" />

<label for="leaveBefore">За сколько минут выходить из дома:</label>
<input type="number" id="leaveBefore" min="1" max="240" value="60" />

<button id="startBtn">Запустить таймер</button>
<button id="resetBtn" style="display:none;">Сбросить таймер</button>
<button id="themeToggle">Переключить тему</button>
<button id="shareBtn" style="display:none;">Поделиться таймером</button>

<div class="timer" style="display:none;">
  <div>До выхода из дома: <span class="time-value" id="timeToLeave">--:--:--</span>
    <div class="progress-container"><div class="progress-bar" id="progressLeave"></div></div>
  </div>
  <div>До начала кино: <span class="time-value" id="timeToMovie">--:--:--</span>
    <div class="progress-container"><div class="progress-bar" id="progressMovie"></div></div>
  </div>
</div>

<audio id="soundStart" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg" preload="auto"></audio>
<audio id="soundHour" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>
<audio id="soundMovie" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" preload="auto"></audio>

<script>
  const movieDateTimeInput = document.getElementById('movieDateTime');
  const leaveBeforeInput = document.getElementById('leaveBefore');
  const startBtn = document.getElementById('startBtn');
  const resetBtn = document.getElementById('resetBtn');
  const timerDiv = document.querySelector('.timer');
  const timeToLeaveSpan = document.getElementById('timeToLeave');
  const timeToMovieSpan = document.getElementById('timeToMovie');
  const progressLeave = document.getElementById('progressLeave');
  const progressMovie = document.getElementById('progressMovie');
  const themeToggleBtn = document.getElementById('themeToggle');
  const shareBtn = document.getElementById('shareBtn');

  const soundStart = document.getElementById('soundStart');
  const soundHour = document.getElementById('soundHour');
  const soundMovie = document.getElementById('soundMovie');

  let intervalId;
  let notifiedLeave = false;
  let notifiedMovie = false;
  let notifiedHourBefore = false;

  // Для синхронизации времени: хранить базовую временную отметку и соответствующий локальный тайм
  let baseTimeUTC = null;   // время события в UTC
  let leaveTimeUTC = null;  // время выхода в UTC

  // Загрузка сохранённых значений из localStorage и URL параметров
  function loadSettings() {
    // Из URL (при наличии)
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('movieDateTime')) {
      movieDateTimeInput.value = urlParams.get('movieDateTime');
    } else {
      const savedMovieDateTime = localStorage.getItem('movieDateTime');
      if (savedMovieDateTime) movieDateTimeInput.value = savedMovieDateTime;
    }

    if (urlParams.has('leaveBefore')) {
      leaveBeforeInput.value = urlParams.get('leaveBefore');
    } else {
      const savedLeaveBefore = localStorage.getItem('leaveBefore');
      if (savedLeaveBefore) leaveBeforeInput.value = savedLeaveBefore;
    }

    // Загрузка темы
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
      document.body.classList.add('dark');
    }
  }

  loadSettings();

  // Форматирует ms в "Xд чч:мм:сс" или "чч:мм:сс", если дней нет
  function formatTime(ms) {
    if (ms <= 0) return "00:00:00";
    const totalSeconds = Math.floor(ms / 1000);
    const days = Math.floor(totalSeconds / 86400);
    const hours = Math.floor((totalSeconds % 86400) / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;

    const timeStr = `${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
    return days > 0 ? `${days}д ${timeStr}` : timeStr;
  }

  // Уведомление (если разрешено)
  function notifyUser(message) {
    if (!("Notification" in window)) {
      alert(message);
    } else if (Notification.permission === "granted") {
      new Notification(message);
    } else if (Notification.permission !== "denied") {
      Notification.requestPermission().then(permission => {
        if (permission === "granted") new Notification(message);
      });
    }
  }

  function playSound(audioElem) {
    audioElem.currentTime = 0;
    audioElem.play().catch(() => {}); // подавляем ошибки, если звук не разрешен
  }

  function updateTimers() {
    const now = Date.now();

    const diffLeave = leaveTimeUTC - now;  // сколько осталось до выхода
    const diffMovie = baseTimeUTC - now;  // сколько осталось до фильма

    // Обновляем текст
    timeToLeaveSpan.textContent = diffLeave > 0 ? formatTime(diffLeave) : 'Пора выходить!';
    timeToMovieSpan.textContent = diffMovie > 0 ? formatTime(diffMovie) : 'Фильм начался!';

    // Прогресс для выхода: 0% - начало обратного отсчёта, 100% - время выхода
    const totalLeave = baseTimeUTC - leaveTimeUTC;
    let leaveProgress = 0;
    if (now < leaveTimeUTC) {
      leaveProgress = ((now - (baseTimeUTC - totalLeave)) / totalLeave) * 100;
      leaveProgress = Math.min(Math.max(leaveProgress, 0), 100);
    } else {
      leaveProgress = 100;
    }

    // Прогресс до фильма: 0% - сейчас, 100% - фильм начинается
    let movieProgress = 0;
    if (now < baseTimeUTC) {
      movieProgress = ((totalLeave + diffLeave) / (totalLeave + totalLeave)) * 100;
      movieProgress = 100 - (diffMovie / (baseTimeUTC - (baseTimeUTC - totalLeave))) * 100;
      movieProgress = Math.min(Math.max(movieProgress, 0), 100);
    } else {
      movieProgress = 100;
    }

    progressLeave.style.width = `${leaveProgress}%`;
    progressMovie.style.width = `${movieProgress}%`;

    // Уведомления
    if (!notifiedLeave && diffLeave <= 0) {
      notifyUser("Пора выходить из дома!");
      playSound(soundStart);
      notifiedLeave = true;
    }
    if (!notifiedHourBefore && diffLeave <= 3600000 && diffLeave > 3500000) { // за час до выхода
      notifyUser("До выхода из дома осталось 1 час!");
      playSound(soundHour);
      notifiedHourBefore = true;
    }
    if (!notifiedMovie && diffMovie <= 0) {
      notifyUser("Фильм начался!");
      playSound(soundMovie);
      notifiedMovie = true;
    }

    // Если фильм начался — останавливаем таймер
    if (diffMovie <= 0) {
      clearInterval(intervalId);
      intervalId = null;
    }
  }

  function startTimer() {
    if (!movieDateTimeInput.value) {
      alert('Выберите дату и время начала фильма.');
      return;
    }
    const movieDate = new Date(movieDateTimeInput.value);
    if (isNaN(movieDate.getTime())) {
      alert('Некорректная дата.');
      return;
    }
    const leaveBeforeMinutes = parseInt(leaveBeforeInput.value, 10);
    if (isNaN(leaveBeforeMinutes) || leaveBeforeMinutes <= 0) {
      alert('Введите корректное время за сколько минут выходить.');
      return;
    }

    // Сохраняем в localStorage
    localStorage.setItem('movieDateTime', movieDateTimeInput.value);
    localStorage.setItem('leaveBefore', leaveBeforeInput.value);

    // Устанавливаем UTC время события и выхода
    baseTimeUTC = movieDate.getTime();
    leaveTimeUTC = baseTimeUTC - leaveBeforeMinutes * 60000;

    notifiedLeave = false;
    notifiedMovie = false;
    notifiedHourBefore = false;

    timerDiv.style.display = 'block';
    startBtn.style.display = 'none';
    resetBtn.style.display = 'inline-block';
    shareBtn.style.display = 'inline-block';

    updateTimers();
    intervalId = setInterval(updateTimers, 1000);
  }

  function resetTimer() {
    clearInterval(intervalId);
    intervalId = null;
    timerDiv.style.display = 'none';
    startBtn.style.display = 'inline-block';
    resetBtn.style.display = 'none';
    shareBtn.style.display = 'none';
    notifiedLeave = false;
    notifiedMovie = false;
    notifiedHourBefore = false;
  }

  startBtn.addEventListener('click', startTimer);
  resetBtn.addEventListener('click', resetTimer);

  themeToggleBtn.addEventListener('click', () => {
    document.body.classList.toggle('dark');
    if (document.body.classList.contains('dark')) {
      localStorage.setItem('theme', 'dark');
    } else {
      localStorage.setItem('theme', 'light');
    }
  });

  shareBtn.addEventListener('click', () => {
    const params = new URLSearchParams();
    params.set('movieDateTime', movieDateTimeInput.value);
    params.set('leaveBefore', leaveBeforeInput.value);
    const shareUrl = `${window.location.origin}${window.location.pathname}?${params.toString()}`;
    navigator.clipboard.writeText(shareUrl).then(() => {
      alert('Ссылка скопирована в буфер обмена!');
    }).catch(() => {
      prompt('Скопируйте ссылку:', shareUrl);
    });
  });

  // Автоматическое обновление страницы каждую минуту (чтобы не было подвисаний)
  setInterval(() => {
    if (!intervalId) return;
    // Можно обновить страницу, но не всегда желательно.
    // Для надежности - можно раскомментировать:
    // location.reload();
  }, 60000);

</script>
</body>
</html>
