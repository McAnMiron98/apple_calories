<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Таймер до кино (множественные события)</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    max-width: 500px;
    margin: 30px auto;
    padding: 15px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    transition: background-color 0.3s, color 0.3s;
  }
  body.dark {
    background: #121212;
    color: #ddd;
  }
  h1 {
    margin-bottom: 25px;
    text-align: center;
  }
  label {
    display: block;
    margin-top: 15px;
    font-weight: 600;
  }
  input, button, select {
    width: 100%;
    padding: 10px;
    margin-top: 6px;
    font-size: 1rem;
    border-radius: 8px;
    border: none;
    box-sizing: border-box;
  }
  input[type="datetime-local"], input[type="number"] {
    box-sizing: border-box;
  }
  button {
    background-color: #ff6f61;
    color: white;
    cursor: pointer;
    font-weight: 700;
    transition: background-color 0.3s ease;
  }
  button:hover {
    background-color: #e85c50;
  }
  .timer, .timers-list {
    margin-top: 20px;
    background: rgba(255,255,255,0.15);
    padding: 20px;
    border-radius: 14px;
  }
  body.dark .timer, body.dark .timers-list {
    background: rgba(255,255,255,0.05);
  }
  .timer div, .timer h3 {
    font-size: 1.1rem;
    margin: 10px 0 5px;
    font-weight: 600;
  }
  .time-value {
    font-family: 'Courier New', Courier, monospace;
    font-size: 1.4rem;
    color: #ffd700;
  }
  .progress-container {
    background: rgba(255,255,255,0.3);
    border-radius: 8px;
    overflow: hidden;
    height: 15px;
    margin-top: 6px;
  }
  body.dark .progress-container {
    background: rgba(255,255,255,0.1);
  }
  .progress-bar {
    height: 100%;
    background-color: #ffd700;
    width: 0%;
    transition: width 0.5s ease;
  }
  .event-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 8px;
  }
  .event-info {
    flex-grow: 1;
    cursor: pointer;
  }
  .event-info.active {
    font-weight: 700;
    color: #ffda6b;
  }
  .btn-delete {
    background: #cc4c4c;
    padding: 4px 10px;
    border-radius: 6px;
    font-weight: 700;
    cursor: pointer;
    margin-left: 8px;
    border: none;
  }
  .btn-delete:hover {
    background: #aa3a3a;
  }
  #showAllBtn {
    margin-top: 10px;
    background-color: #4caf50;
  }
</style>
</head>
<body>

<h1>Таймер до кино (множественные события)</h1>

<form id="addEventForm">
  <label for="eventName">Название фильма / описание:</label>
  <input type="text" id="eventName" required placeholder="Название фильма" />

  <label for="movieDateTime">Дата и время начала кино:</label>
  <input type="datetime-local" id="movieDateTime" required />

  <label for="leaveBefore">За сколько минут выходить из дома:</label>
  <input type="number" id="leaveBefore" min="1" max="240" value="60" required />

  <button type="submit">Добавить киносеанс</button>
</form>

<div class="timers-list">
  <h2>Список киносеансов</h2>
  <div id="eventsContainer"></div>
  <button id="showAllBtn">Показать все таймеры</button>
</div>

<div id="timersDisplay"></div>

<button id="themeToggle" style="margin-top:20px;">Переключить тему</button>

<audio id="soundStart" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg" preload="auto"></audio>
<audio id="soundHour" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>
<audio id="soundMovie" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" preload="auto"></audio>

<script>
(() => {
  const form = document.getElementById('addEventForm');
  const eventsContainer = document.getElementById('eventsContainer');
  const timersDisplay = document.getElementById('timersDisplay');
  const themeToggleBtn = document.getElementById('themeToggle');
  const showAllBtn = document.getElementById('showAllBtn');

  const soundStart = document.getElementById('soundStart');
  const soundHour = document.getElementById('soundHour');
  const soundMovie = document.getElementById('soundMovie');

  let events = [];
  let activeEventId = null;  // null = показывать все
  let intervalId = null;

  // Загрузка из localStorage
  function loadFromStorage() {
    const savedEvents = localStorage.getItem('movieEvents');
    if (savedEvents) {
      try {
        events = JSON.parse(savedEvents);
      } catch {
        events = [];
      }
    }
    activeEventId = localStorage.getItem('activeEventId');
    if (activeEventId === 'null' || !activeEventId) activeEventId = null;
  }

  // Сохранение в localStorage
  function saveToStorage() {
    localStorage.setItem('movieEvents', JSON.stringify(events));
    localStorage.setItem('activeEventId', activeEventId);
  }

  // Форматирование времени
  function formatTime(ms) {
    if (ms <= 0) return "00:00:00";
    const totalSeconds = Math.floor(ms / 1000);
    const days = Math.floor(totalSeconds / 86400);
    const hours = Math.floor((totalSeconds % 86400) / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;

    const timeStr = `${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
    return days > 0 ? `${days}д ${timeStr}` : timeStr;
  }

  // Уведомления
  function notifyUser(message) {
    if (!("Notification" in window)) {
      alert(message);
    } else if (Notification.permission === "granted") {
      new Notification(message);
    } else if (Notification.permission !== "denied") {
      Notification.requestPermission().then(permission => {
        if (permission === "granted") new Notification(message);
      });
    }
  }

  function playSound(audioElem) {
    audioElem.currentTime = 0;
    audioElem.play().catch(() => {});
  }

  // Рендер списка событий (с возможностью выбрать активный и удалить)
  function renderEventsList() {
    eventsContainer.innerHTML = '';
    if (events.length === 0) {
      eventsContainer.textContent = 'Событий пока нет.';
      return;
    }
    events.forEach(ev => {
      const div = document.createElement('div');
      div.className = 'event-item';

      const info = document.createElement('div');
      info.className = 'event-info' + (ev.id === activeEventId ? ' active' : '');
      info.textContent = `${ev.name} — начало: ${new Date(ev.movieDateTime).toLocaleString()}, выходить за ${ev.leaveBefore} мин`;
      info.title = "Кликните, чтобы выбрать этот сеанс";
      info.onclick = () => {
        if (activeEventId === ev.id) {
          activeEventId = null; // сброс выбора — показывать все
        } else {
          activeEventId = ev.id;
        }
        saveToStorage();
        renderEventsList();
        renderTimers();
      };

      const btnDel = document.createElement('button');
      btnDel.className = 'btn-delete';
      btnDel.textContent = '×';
      btnDel.title = "Удалить событие";
      btnDel.onclick = (e) => {
        e.stopPropagation();
        if (confirm(`Удалить событие "${ev.name}"?`)) {
          events = events.filter(x => x.id !== ev.id);
          if (activeEventId === ev.id) activeEventId = null;
          saveToStorage();
          renderEventsList();
          renderTimers();
        }
      };

      div.appendChild(info);
      div.appendChild(btnDel);
      eventsContainer.appendChild(div);
    });
  }

  // Создание DOM для одного таймера (одного события)
  function createTimerDom(ev) {
    const container = document.createElement('div');
    container.className = 'timer';

    const now = Date.now();
    const startTime = new Date(ev.movieDateTime).getTime();
    const leaveTime = startTime - ev.leaveBefore * 60000;

    const toLeaveMs = leaveTime - now;
    const toStartMs = startTime - now;

    // Надписи
    const title = document.createElement('h3');
    title.textContent = ev.name;
    container.appendChild(title);

    // Время до выхода из дома
    const leaveLabel = document.createElement('div');
    leaveLabel.textContent = 'Время выйти из дома:';
    const leaveTimeVal = document.createElement('div');
    leaveTimeVal.className = 'time-value';
    leaveTimeVal.textContent = formatTime(toLeaveMs);
    container.appendChild(leaveLabel);
    container.appendChild(leaveTimeVal);

    // Прогресс выхода
    const leaveProgressCont = document.createElement('div');
    leaveProgressCont.className = 'progress-container';
    const leaveProgressBar = document.createElement('div');
    leaveProgressBar.className = 'progress-bar';
    leaveProgressCont.appendChild(leaveProgressBar);
    container.appendChild(leaveProgressCont);

    // Время до начала фильма
    const startLabel = document.createElement('div');
    startLabel.textContent = 'Время до начала фильма:';
    const startTimeVal = document.createElement('div');
    startTimeVal.className = 'time-value';
    startTimeVal.textContent = formatTime(toStartMs);
    container.appendChild(startLabel);
    container.appendChild(startTimeVal);

    // Прогресс до начала фильма
    const startProgressCont = document.createElement('div');
    startProgressCont.className = 'progress-container';
    const startProgressBar = document.createElement('div');
    startProgressBar.className = 'progress-bar';
    startProgressCont.appendChild(startProgressBar);
    container.appendChild(startProgressCont);

    // Рассчёт прогресса
    // Общий интервал - от now до leaveTime (для выхода) и от now до startTime (для фильма)
    // Когда прошло больше времени, прогресс = 100%
    // Общее время от "текущий момент" до "событие" — оставшееся, но для прогресса считаем изначальное расстояние

    // Для прогресса выхода: с момента now до leaveTime по отношению к разнице leaveTime - startTime + leaveBefore*60*1000
    // Точнее: Прогресс выхода: сколько прошло времени от (текущего времени) до (время добавления события или момент с добавлением) по отношению к общему времени ожидания

    // Для прогрессов удобнее считать как:
    // leaveProgress = (totalTimeToLeave - timeLeftToLeave) / totalTimeToLeave
    // startProgress = (totalTimeToStart - timeLeftToStart) / totalTimeToStart

    // totalTimeToLeave = leaveTime - (startTime - leaveBefore)
    // Но проще: 
    // Для выхода: от (текущее время) до (leaveTime), исходно от (текущее время на момент добавления) до leaveTime
    // Чтобы не усложнять, будем считать прогресс по текущему времени и фиксированному времени добавления

    // Запишем время добавления события
    if (!ev.createdAt) {
      ev.createdAt = now;
      saveToStorage();
    }
    const totalLeaveInterval = leaveTime - ev.createdAt;
    const totalStartInterval = startTime - ev.createdAt;

    // Функция для обновления прогресс-баров и таймеров
    function update() {
      const nowLocal = Date.now();
      const leftLeave = leaveTime - nowLocal;
      const leftStart = startTime - nowLocal;

      leaveTimeVal.textContent = formatTime(leftLeave);
      startTimeVal.textContent = formatTime(leftStart);

      let leaveProgress = totalLeaveInterval > 0 ? (1 - leftLeave / totalLeaveInterval) * 100 : 100;
      if (leaveProgress < 0) leaveProgress = 0;
      if (leaveProgress > 100) leaveProgress = 100;
      leaveProgressBar.style.width = leaveProgress + '%';

      let startProgress = totalStartInterval > 0 ? (1 - leftStart / totalStartInterval) * 100 : 100;
      if (startProgress < 0) startProgress = 0;
      if (startProgress > 100) startProgress = 100;
      startProgressBar.style.width = startProgress + '%';

      // Звуки и уведомления (один раз на событие)
      if (!ev.notifiedStart && leftLeave <= 0 && leftStart > 0) {
        // Пора выходить из дома
        playSound(soundStart);
        notifyUser(`Пора выходить на киносеанс "${ev.name}"!`);
        ev.notifiedStart = true;
        saveToStorage();
      }
      if (!ev.notifiedHour && leftStart <= 3600000 && leftStart > 3500000) {
        // За час до начала
        playSound(soundHour);
        notifyUser(`Остался час до киносеанса "${ev.name}".`);
        ev.notifiedHour = true;
        saveToStorage();
      }
      if (!ev.notifiedMovie && leftStart <= 0) {
        playSound(soundMovie);
        notifyUser(`Фильм "${ev.name}" уже начался!`);
        ev.notifiedMovie = true;
        saveToStorage();
      }
    }

    update();

    return { container, update };
  }

  // Рендер таймеров (либо один активный, либо все)
  let timersObjects = [];
  function renderTimers() {
    timersDisplay.innerHTML = '';
    timersObjects = [];

    let toRender = [];
    if (activeEventId) {
      const ev = events.find(e => e.id === activeEventId);
      if (ev) toRender.push(ev);
    } else {
      toRender = [...events];
    }

    if (toRender.length === 0) {
      timersDisplay.textContent = 'Нет доступных событий для показа таймеров.';
      return;
    }

    toRender.forEach(ev => {
      const timerObj = createTimerDom(ev);
      timersDisplay.appendChild(timerObj.container);
      timersObjects.push(timerObj);
    });
  }

  // Обновление всех таймеров каждую секунду
  function startInterval() {
    if (intervalId) clearInterval(intervalId);
    intervalId = setInterval(() => {
      timersObjects.forEach(t => t.update());
    }, 1000);
  }

  // Обработка добавления нового события
  form.onsubmit = e => {
    e.preventDefault();
    const name = form.eventName.value.trim();
    const movieDateTimeStr = form.movieDateTime.value;
    const leaveBefore = parseInt(form.leaveBefore.value, 10);

    if (!name || !movieDateTimeStr || isNaN(leaveBefore)) {
      alert('Пожалуйста, заполните все поля корректно.');
      return;
    }

    const movieDateTime = new Date(movieDateTimeStr);
    if (movieDateTime <= new Date()) {
      alert('Дата и время начала должны быть в будущем.');
      return;
    }
    if (leaveBefore <= 0 || leaveBefore > 240) {
      alert('Время выхода из дома должно быть от 1 до 240 минут.');
      return;
    }

    // Создаем уникальный ID
    const id = Date.now().toString(36) + Math.random().toString(36).slice(2,6);

    events.push({
      id,
      name,
      movieDateTime: movieDateTime.toISOString(),
      leaveBefore,
      createdAt: Date.now(),
      notifiedStart: false,
      notifiedHour: false,
      notifiedMovie: false,
    });

    form.reset();
    saveToStorage();
    renderEventsList();
    renderTimers();
  };

  // Переключение темы
  themeToggleBtn.onclick = () => {
    document.body.classList.toggle('dark');
  };

  // Кнопка показать все таймеры / сброс выбора
  showAllBtn.onclick = () => {
    activeEventId = null;
    saveToStorage();
    renderEventsList();
    renderTimers();
  };

  // Инициализация
  loadFromStorage();
  renderEventsList();
  renderTimers();
  startInterval();

  // Запрос разрешения на уведомления
  if (Notification.permission !== "granted" && Notification.permission !== "denied") {
    Notification.requestPermission();
  }

})();
</script>

</body>
</html>
